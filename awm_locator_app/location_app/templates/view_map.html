{% extends 'base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <title>{% block title %}Map Page{% endblock %}</title>
</head>
<body>
    {% block navbar %}
    <nav class="navbar navbar-expand-md bg-dark navbar-dark">
      <ul class="navbar-nav mr-auto">
             {% if user.is_authenticated %}
              <a class="navbar-brand" href="{% url 'menu' %}">AWM Locator App</a>

                 <li class="nav-item">
                     <a class="nav-link" href="{% url 'menu' %}">Menu</a>
                 </li>
      </ul>
             <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                     <a class="nav-link disabled" href="#" >Hello {{user.username}}!</a>
                </li>

                 <li class="nav-item">
                     <a class="nav-link" href="{% url 'logout' %}">Log Out</a>
                 </li>
             </ul>
         {% else %}
        <ul>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}">Login</a>
             </li>
         {% endif %}
      </ul>
    </nav>
    {% endblock %}

    {% block content %}
        {% load leaflet_tags %}
        {% leaflet_css %}
        {% leaflet_js %}
        <h3 class="text-center m-3">Your Location</h3>

        <div class="map-container">
            <div id='map'>{% leaflet_map "locator_map" %}</div>
        </div>

        <form method="post" action="{% url 'update_location' %}">
            {% csrf_token %}
        </form>

        <script>

            let map = L.map('map');

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 30,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            map.locate({setView: true, maxZoom: 30});

            function onLocationFound(e) {

                let radius = e.accuracy;
                let lat = e.latlng.lat;
                let long  = e.latlng.lng;
                let location = lat + ", " + long;

                L.marker(e.latlng).addTo(map)
                .bindPopup("Location Found.\n\nLat: " + lat + ", Long: " + long +
                "\nUpdating database with location").openPopup();

                 L.circle(e.latlng, radius).addTo(map);

                console.log(lat + " " + long);
                updateLocation(location, lat, long);

            }

            function onLocationError(e) {
                alert(e.message);
            }

            map.on('locationerror', onLocationError);
            map.on('locationfound', onLocationFound);

            map.locate({setView: true, maxZoom: 16});

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function updateLocation(location, lat, long) {

                console.log("In updatelocation(): " + location);
                let csrftoken = getCookie('csrftoken');

                let request = fetch('{% url 'update_location' %}', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({latitude: lat, longitude: long})

                });

                request.then(response => response.json());
                request.then(data => console.log(data));
            }

        </script>
    {% endblock %}
</body>
</html>