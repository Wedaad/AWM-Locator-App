{% extends 'base.html' %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <title>{% block title %}Map Page{% endblock %}</title>
</head>
<body>
    {% block navbar %}
    <nav class="navbar navbar-expand-md bg-dark navbar-dark">
      <ul class="navbar-nav mr-auto">
             {% if user.is_authenticated %}
              <a class="navbar-brand" href="{% url 'menu' %}">AWM Locator App</a>

                 <li class="nav-item">
                     <a class="nav-link" href="{% url 'menu' %}">Menu</a>
                 </li>
      </ul>
             <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                     <a class="nav-link disabled" href="#" >{{user.username}}</a>
                </li>

                 <li class="nav-item">
                     <a class="nav-link" href="{% url 'logout' %}">Log Out</a>
                 </li>
             </ul>
         {% else %}
        <ul>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'login' %}">Login</a>
             </li>
         {% endif %}
      </ul>
    </nav>
    {% endblock %}

    {% block content %}
        {% load leaflet_tags %}
        {% leaflet_css %}
        {% leaflet_js %}
        <h3 class="text-center m-3">Your Location</h3>

        <div class="map-container">
            <div id='map'>{% leaflet_map "locator_map" %}</div>
        </div>

        <script>
                let map = L.map('map').fitWorld();

                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 30,
                    attribution: 'Â© OpenStreetMap'
                }).addTo(map);

                map.locate({setView: true, maxZoom: 30});

                function findUserLocation(e) {

                    let radius = e.accuracy * 5;
                    let lat = e.latlng.lat;
                    let long  = e.latlng.lng;

                    L.marker(e.latlng).addTo(map)
                    // .bindPopup("You are within " + radius + " meters from this point").openPopup();
                    .bindPopup("Location Found.\n\nLat: " + lat + ", Long: " + long +
                    "\nUpdating database with location").openPopup();

                     L.circle(e.latlng, radius).addTo(map);

                     console.log("location: " + lat + " " + " " + long);
                }

                map.on('locationfound', findUserLocation);

                function noUserLocation(e) {
                    alert(e.message);
                }

                map.on('locationerror', noUserLocation);

        </script>
    {% endblock %}
</body>
</html>